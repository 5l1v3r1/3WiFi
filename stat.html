<html><head>
<title>3WiFi: Статистика</title>
<meta http-equiv=Content-Type content="text/html;charset=UTF-8">
<link rel=stylesheet href="css/style.css" type="text/css">
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
function appendRow(rowid, idx, p1, p2, tt, of, th)
{
	var td1 = $((th ? '<th>' : '<td>')).text(p1);
	var td2 = $((th ? '<th>' : '<td>')).text(p2);
	if (tt) td2.css('font-family', 'monospace');
	if (of && (p2.length > 64))
	{
		td2.css('max-width', '700px');
		td2.css('overflow-x', 'scroll');
	}
	var tr = $('<tr>');
	tr.append(td1);
	tr.append(td2);
	$('#'+rowid).append(tr);
}
function parsestat(st, d)
{
	if (typeof d.stat.top == 'number')
	{
		$('#sttot').text('('+d.stat.total+')');
		$('#stcnt').text('(топ'+d.stat.top+')');
	} else {
		var total = 0;
		for (var i = 0; i < d.stat.data.length; i++)
		{
			total += d.stat.data[i][0];
		}
		$('#sttot').text('('+total+')');
		$('#stcnt').text('('+d.stat.data.length+')');
	}
	var tt = (st == 'stbss' || st == 'stwps');
	var of = (st == 'stauth');
	for (var i = 0; i < d.stat.data.length; i++)
	{
		appendRow('stat', i, d.stat.data[i][0], d.stat.data[i][1], tt, of);
	}
}
function loadstat(st)
{
	$('button').prop('disabled', true);
	$('#stval').text('Загрузка...');
	$('#sttot').empty();
	$('#stcnt').empty();
	$('#stat').html('<tr><td></td><td><img src="img/loading.gif"></td></tr>');
	$.get('3wifi.php?a=' + st, function(d)
	{
		if (d.result)
		{
			$('#stat').empty();
			switch (st)
			{
				case 'stat':
				$('#stat_cap').text('Статистика от '+d.stat.date+' UTC.');
				$('#stval').text('Сводная таблица');
				appendRow('stat', 0, d.stat.total, 'Всего записей в базе');
				appendRow('stat', 1, d.stat.bssids, 'С корректным BSSID');
				appendRow('stat', 2, d.stat.uniqbss, 'С уникальным BSSID');
				appendRow('stat', 3, d.stat.onmap, 'Найдено на карте');
				appendRow('stat', 4, 'Кол-во', 'Состояние заданий', false, false, true);
				appendRow('stat', 5, d.stat.tasks.uploading, 'Заданий на загрузке', true);
				appendRow('stat', 6, d.stat.tasks.processing, 'Заданий в обработке', true);
				if (d.stat.tasks.comment != null)
					appendRow('stat', 7, '✓', 'Сейчас обрабатывается: ' + d.stat.tasks.comment + '', true);
				appendRow('stat', 8, d.stat.geoloc, 'Определение координат', true);
				break;
				case 'stcmt':
				$('#stval').text('Комментарии');
				parsestat(st, d);
				break;
				case 'stdev':
				$('#stval').text('Названия устройств / прошивок');
				parsestat(st, d);
				break;
				case 'stport':
				$('#stval').text('Порты');
				parsestat(st, d);
				break;
				case 'stauth':
				$('#stval').text('Данные авторизации');
				parsestat(st, d);
				break;
				case 'stbss':
				$('#stval').text('BSSID / MAC-адрес');
				parsestat(st, d);
				break;
				case 'stess':
				$('#stval').text('ESSID / Имя сети');
				parsestat(st, d);
				break;
				case 'stsec':
				$('#stval').text('Тип защиты');
				parsestat(st, d);
				break;
				case 'stkey':
				$('#stval').text('Ключ сети');
				parsestat(st, d);
				break;
				case 'stwps':
				$('#stval').text('Пин код WPS');
				parsestat(st, d);
				break;
				case 'stdns':
				$('#stval').text('Серверы доменных имён');
				parsestat(st, d);
				break;
				case 'stsid':
				$('#stval').text('Активные участники');
				parsestat(st, d);
				break;
			}
		} else {
			$('#stat > tr:nth-child(2) > :nth-child(2)').text('Ошибка загрузки данных.');
		}
		$('button').prop('disabled', false);
	});
}
</script>
</head>

<body onload="loadstat('stat')">
<h2 align="center"><span id=stat_cap>Статистика загружается...</span></h2>
<noscript>Включите JavaScript для отображения данных.</noscript>

<p><button onclick="loadstat('stat')">Сводная</button>&nbsp;
<button onclick="loadstat('stcmt')">Комментарии</button>&nbsp;
<button onclick="loadstat('stdev')">Устройства</button>&nbsp;
<button onclick="loadstat('stport')">Порты</button>&nbsp;
<button onclick="loadstat('stauth')">Авторизация</button>&nbsp;
<button onclick="loadstat('stbss')">BSSID</button>&nbsp;
<button onclick="loadstat('stess')">ESSID</button>&nbsp;
<button onclick="loadstat('stsec')">Защита</button>&nbsp;
<button onclick="loadstat('stkey')">Ключи</button>&nbsp;
<button onclick="loadstat('stwps')">WPS</button>&nbsp;
<button onclick="loadstat('stdns')">DNS</button>&nbsp;
<button onclick="loadstat('stsid')">Сиды</button></p>

<table class=st1>
<tbody>
<tr><th>Кол-во <span id=sttot></span></th><th><span id=stval>Значение</span> <span id=stcnt></span></th></tr>
</tbody>
<tbody id=stat></tbody>
</table>

</body></html>