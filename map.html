<title>3WiFi: Карта точек доступа</title>

<head>
<script src="//api-maps.yandex.ru/2.1/?lang=ru-RU" type="text/javascript"></script>
<script src="FileSaver.min.js" type="text/javascript"></script>
<script type="text/javascript">
function initmap()
{
	myMap = new ymaps.Map('map', {
		center: [%var_lat%, %var_lon%],
		zoom: 18,
		controls: ['geolocationControl','searchControl','typeSelector','fullscreenControl','zoomControl']
	}),

	remoteObjectManager = new ymaps.RemoteObjectManager('3wifi.php?a=map&tileNumber=%t&zoom=%z',
	{	// Разбивать запросы по тайлам
		splitRequests: false,
		// Опции кластеров задаются с префиксом cluster.
		clusterHasBalloon: false,
		clusterHasHint: true,
		// Опции объектов задаются с префиксом geoObject
		geoObjectOpenBalloonOnClick: false
	});

	myMap.geoObjects.add(remoteObjectManager);

	var saveButton = new ymaps.control.Button('Сохранить');
	saveButton.events.add('click', function ()
	{
		var points = [];
		var element = document.createElement('div'); // to convert special html chars
		remoteObjectManager.objects.each(function (el)
		{
			//if (!remoteObjectManager.getObjectState(el.id).isShown) { return; }
			var lat = el.geometry.coordinates[0];
			var lon = el.geometry.coordinates[1];
			var hints = el.properties.hintContent.split('<hr>');
			for (var i = 0, l = hints.length; i < l; i++)
			{
				element.innerHTML = hints[i].split('<br>').slice(1).concat([lat, lon]).join("\t") + "\r\n";
				hints[i] = element.textContent;
				element.textContent = '';
			}
			points = points.concat(hints);
		});
		var blob = new Blob(points, {type: 'text/plain; charset=utf-8'});
		saveAs(blob, '');
	});
	myMap.controls.add(saveButton, {float: 'right', selectOnClick: false});
}
function initpage()
{
	$('.content').css('padding-left', '0px');
	$('.content').css('padding-right', '0px');
	$('.content').css('padding-top', '0px');
	$('.content').css('padding-bottom', '0px');
	ymaps.ready(initmap);	
}
</script>
</head>

<body>
<div id=map style="width: 100%; height: 100%"></div>
</body>