<title>3WiFi: Учетная запись</title>

<head>
<script type="text/javascript">
function levelToText(level)
{
	switch (level)
	{
		case -2: return 'Заблокирован';
		case -1: return 'Не авторизован';
		case 0: return 'Гостевой аккаунт';
		case 1: return 'Пользователь';
		case 2: return 'Продвинутый';
		case 3: return 'Администратор';
		default: return 'Н/Д';
	}
}
function initpage()
{
	if (ProfileInfo.isUser == 0) window.location.href = 'home';

	$('.content').css('padding-top', '0px');
	stLoading = false;

	$('.user_tab').click(function()
	{
		var elem_content = this.getElementsByClassName('user_tab_content')[0];
		elem_content.style.display = (elem_content.style.display == 'none') ? 'block' : 'none';
	});

	$('#userlevel').text(levelToText(ProfileInfo.Level));
	if (window.location.hash != '')
	{
		var tab = 'a[href='+window.location.hash+']';
		if ($(tab).length > 0) $(tab).click();
	}
 	for (var i = 0; i <= (ProfileInfo.Level < 3 ? 1 : 3); i++)
		$('#invlevel').append($('<option>').val(i).text(levelToText(i)));
}

function getMyUploads()
{
	$('#uploaded').html('<tr><td colspan=11><img src="img/loading.gif"></td></tr>');
	$.get('user.php?a=myuploads', function(json)
	{
		$('#uploaded').empty();
		if (!json.result)
		{
			$('#uploaded').html('<tr><td colspan=11>'+errorStr(json.error)+'</td></tr>');
			return;
		}
		if (json.data.length == 0)
		{
			$('#uploaded').html('<tr><td colspan=11>Загруженных вами точек пока нет</td></tr>');
			return;
		}
		for (var i = 0; i < json.data.length; i++)
		{
			var ap = json.data[i];
			var tr = $('<tr>');
			tr.append($('<td>').css({'font-family': 'monospace', 'white-space': 'nowrap'}).text(ap.time));
			tr.append($('<td>').text(ap.comment));
			tr.append($('<td>').css({'font-family': 'monospace'}).text(ap.ipport));
			tr.append($('<td>').text(ap.auth));
			tr.append($('<td>').text(ap.name));
			tr.append($('<td>').css({'font-family': 'monospace'}).text(ap.bssid));
			tr.append($('<td>').css({'white-space': 'nowrap'}).text(ap.essid));
			tr.append($('<td>').text(ap.sec));
			tr.append($('<td>').css({'white-space': 'nowrap'}).text(ap.key));
			tr.append($('<td>').css({'font-family': 'monospace'}).text(ap.wps));
			var urls = '';
			if (typeof ap.lat == 'number')
			{
				urls += '<a href="map?lat='+ap.lat+'&lon='+ap.lon+'"><img src="img/icon-map.png"></a>&nbsp;';
				urls += '<a href="ranges?lat='+ap.lat+'&lon='+ap.lon+'"><img src="img/icon-ip.png"></a>';
			}
			tr.append($('<td>').html(urls));
			$('#uploaded').append(tr);
		}
	});
}

function myDownload()
{
	$.get('user.php?a=dlcheck', function(json)
	{
		if (!json.result)
		{
			alert(errorStr(json.error));
			return;
		}
		if (json.count == 0)
		{
			alert('У вас нет загруженных точек.');
			return;
		}
		var a = document.createElement('a');
		a.href = 'user.php?a=download';
		a.download = 'myuploads.txt';
		a.target = '_blank';
		a.click();
		a.remove();
	});
}

function createInvite()
{
	$.get('user.php?a=createinv&level='+$('#invlevel').val(), function(json)
	{
		if (!json.result)
		{
			alert(errorStr(json.error));
			return;
		}
		ProfileInfo.invites--;
		getInvitesInfo();
	});
}

function updateInvite()
{
	var checked = $('.invchk:checked').parent().parent().children(':nth-child(4)');
	for (var i = 0; i < checked.length; i++)
	{
		var inv = $(checked[i]).text();
		$.post('user.php?a=updateinv', 'invite='+inv+'&level='+$('#invlevel').val(), function(json)
		{
			if (!json.result)
			{
				alert(errorStr(json.error));
				return;
			}
			getInvitesInfo();
		});
	}
	$('#invchkall').prop('checked', false);
}

function deleteInvite()
{
	var checked = $('.invchk:checked').parent().parent().children(':nth-child(4)');
	for (var i = 0; i < checked.length; i++)
	{
		var inv = $(checked[i]).text();
		$.post('user.php?a=deleteinv', 'invite='+inv, function(json)
		{
			if (!json.result)
			{
				alert(errorStr(json.error));
				return;
			}
			ProfileInfo.invites++;
			getInvitesInfo();
		});
	}
	$('#invchkall').prop('checked', false);
}

function getInvitesInfo()
{
	$.post('user.php?a=myinvites', '', function(json)
	{
		var table = $('#invtable');
		table.empty();

		$('#invcount').text(ProfileInfo.Level < 3 ? ProfileInfo.invites : 'безлимит');

		if (!json.result)
		{
			alert(errorStr(json.error));
			return;
		}
		if (json.data.length > 0)
		{
			for (var i in json.data)
			{
				var inv = json.data[i];

				var invite = inv['invite'];
				var nick = inv['nick'];
				if (nick) invite = '<s>'+invite+'</s>';

				var tr1 = $('<tr>').append($('<td>').html('<input type=checkbox class=invchk>'))
							.append($('<td>').text(inv['time']))
							.append($('<td>').text(inv['regdate']))
							.append($('<td>').html(invite))
							.append($('<td>').text(levelToText(inv['level'])))
							.append($('<td>').text(nick));

				table.append(tr1);
			}
		}
		else
		{
			table.html('<tr><td colspan=6>Нет созданных приглашений</td></tr>');
		}
	});
}

function editNick()
{
	if ($('#nickeditor').css('display') == 'none')
	{
		$('#nicklabel').hide();
		$('#nickeditor').show();
		$('#nickedit').val(ProfileInfo.Nickname).focus();
	}
	else
	{
		$('#nickeditor').hide();
		$('#nicklabel').show();
	}
}

function changeNick()
{
	var newnick = $('#nickedit').val();
	$('#nickeditor').children().prop('disabled', true);
	$.post('user.php?a=changenick', 'nick='+encodeURIComponent(newnick), function(json)
	{
		if (!json.result)
		{
			alert(errorStr(json.error));
			$('#nickeditor').children().prop('disabled', false);
			return;
		} else {
			alert("Никнейм успешно изменён");
			location.reload(true);
		}
	});
}

function changePassword()
{
	var pass = $('#win_newpass [name=password]').val();
	if (! (pass == $('#win_newpass [name=password2]').val())) {
		alert("Пароли не совпадают");
		return;
	}
	$.post('user.php?a=changepass', 'password='+encodeURIComponent(pass), function(json)
	{
		if (!json.result)
		{
			alert(errorStr(json.error));
			return;
		} else {
			alert("Пароль успешно изменён");
			hideModal();
		}
	});
	return;
}

function createApiKey(type)
{
	$.post('user.php?a=createapikey', 'type='+type, function(json)
	{
		if (!json.result)
		{
			alert(errorStr(json.error));
			return;
		}
		if(json.data.r) $('#rapikey').text(json.data.r);
		if(json.data.w) $('#wapikey').text(json.data.w);
	});
}

function switchTab(num)
{
	$('.userTabActive').prop('class', 'userTab');
	$('#tab'+num+'b').prop('class', 'userTabActive');
	for (var i = 1; i <= 10; i++)
	{
		if (i == num) { $('#tab'+i).show(); } else { $('#tab'+i).hide(); };
	}
	switch (num)
	{
		case 2: getMyUploads();
		break;
		case 4: getInvitesInfo();
		break;
		case 5: $('td#stat_em')[0].click();
		break;
	}
}

function appendRow(rowid, idx, p1, p2, tt, of, th)
{
	var td1 = $((th ? '<th>' : '<td>')).text(p1);
	var td2 = $((th ? '<th>' : '<td>')).text(p2);
	if (tt) td2.css('font-family', 'monospace');
	if (of && (p2.length > 64))
	{
		td2.css('max-width', '700px');
		td2.css('overflow-x', 'scroll');
	}
	var tr = $('<tr>');
	tr.append(td1);
	tr.append(td2);
	$('#'+rowid).append(tr);
}

function parsestat(st, d)
{
	if(!d.stat.data) return;
	
	if (typeof d.stat.top == 'number')
	{
		$('#sttot').text('('+d.stat.total+')');
		$('#stcnt').text('(топ'+d.stat.top+')');
	} else {
		var total = 0;
		for (var i = 0; i < d.stat.data.length; i++)
		{
			total += d.stat.data[i][0];
		}
		$('#sttot').text('('+total+')');
		$('#stcnt').text('('+d.stat.data.length+')');
	}
	var tt = (st == 'stbss' || st == 'stwps');
	var of = (st == 'stauth');
	for (var i = 0; i < d.stat.data.length; i++)
	{
		appendRow('stat', i, d.stat.data[i][0], d.stat.data[i][1], tt, of);
	}
}

function loadstat(e, st)
{
	if (stLoading) return;

	stLoading = true;
	$('td#stat_em').removeClass('stat_sel');
	e.className = 'stat_sel';
	$('.st1').show();
	$('#stval').text('Загрузка...');
	$('#sttot').empty();
	$('#stcnt').empty();
	$('#stat').html('<tr><td></td><td><img src="img/loading.gif"></td></tr>');
	$.get('user.php?a=' + st, function(d)
	{
		stLoading = false;
		if (d.result)
		{
			$('#stat').empty();
			switch (st)
			{
				case 'stat':
				$('#stval').text('Сводная таблица');
				appendRow('stat', 0, d.stat.total, 'Загружено точек вами');
				appendRow('stat', 1, d.stat.bssids, 'С корректным BSSID');
				appendRow('stat', 2, d.stat.uniqbss, 'С уникальным BSSID');
				appendRow('stat', 3, d.stat.onmap, 'Найдено на карте');
				break;
				case 'stcmt':
				$('#stval').text('Комментарии');
				parsestat(st, d);
				break;
				case 'stdev':
				$('#stval').text('Названия устройств / прошивок');
				parsestat(st, d);
				break;
				case 'stport':
				$('#stval').text('Порты');
				parsestat(st, d);
				break;
				case 'stauth':
				$('#stval').text('Данные авторизации');
				parsestat(st, d);
				break;
				case 'stbss':
				$('#stval').text('BSSID / MAC-адрес');
				parsestat(st, d);
				break;
				case 'stess':
				$('#stval').text('ESSID / Имя сети');
				parsestat(st, d);
				break;
				case 'stsec':
				$('#stval').text('Тип защиты');
				parsestat(st, d);
				break;
				case 'stkey':
				$('#stval').text('Ключ сети');
				parsestat(st, d);
				break;
				case 'stwps':
				$('#stval').text('Пин код WPS');
				parsestat(st, d);
				break;
				case 'stdns':
				$('#stval').text('Серверы доменных имён');
				parsestat(st, d);
				break;
				case 'stsid':
				$('#stval').text('Активные участники');
				parsestat(st, d);
				break;
			}
		} else {
			$('#stval').text('Нет данных');
			$('#stat > tr > :nth-child(2)').text(errorStr(d.error));
		}
	});
}

</script>
</head>

<body>
<h2 align=center><span class=header_cap>Управление пользователем %nick%</span></h2>

<div class=usetTabContainer>
	<div class=userTabs>
		<div id=tab1b class=userTabActive dir=ltr><a href="#info" onclick="switchTab(1)">Данные профиля</a></div>
		<div id=tab2b class=userTab dir=ltr><a href="#uploads" onclick="switchTab(2)">Загруженные точки</a></div>
		<div id=tab3b class=userTab dir=ltr><a href="#fave" onclick="switchTab(3)">Избранное</a></div>
		<div id=tab4b class=userTab dir=ltr><a href="#inv" onclick="switchTab(4)">Приглашения</a></div>
		<div id=tab5b class=userTab dir=ltr><a href="#stats" onclick="switchTab(5)">Моя статистика</a></div>
	</div>
	<div class=userCodeContainer>
		<div id=tab1 class=userCode dir=ltr style="display: block;">
			<table>
			<tr><td>Логин:</td><td>%login%</td></tr>
			<tr><td>Никнейм:</td><td>
				<span id=nicklabel>%nick% <a href="javascript://" onclick="editNick()">(изменить)</a></span>
				<span id=nickeditor style="display:none"><input type=text id=nickedit />&nbsp;<button onclick="changeNick()">Сохранить</button>&nbsp;<button onclick="editNick()">Отменить</button></span>
			</td></tr>
			<tr><td>Дата регистрации:</td><td>%regdate%</td></tr>
			<tr><td>Уровень:</td><td id=userlevel></td></tr>
			<tr><td>Пароль:</td><td><a href="javascript://" onclick="showModal('#win_newpass')">Изменить</a></td></tr>
			<tr><td>API ключ/чтение:</td><td><span id="rapikey">%rapikey%</span> <a href="javascript://" onclick="createApiKey(1)">(получить новый)</a></td></tr>
			<tr><td>API ключ/запись:</td><td><span id="wapikey">%wapikey%</span> <a href="javascript://" onclick="createApiKey(2)">(получить новый)</a></td></tr>
			<tr><td>Пригласивший:</td><td>%refuser%</td></tr>
			</table>
		</div>
		<div id=tab2 class=userCode dir=ltr style="display: none;">
			<div style="max-height: 100%; overflow: auto">
				<p style="margin-top: 7px">Отображается 200 последних загруженных точек. <a href="javascript://" onclick="myDownload()">Скачать все (.txt)</a>.</p>
				<table class=st1 align=center>
				<thead style="white-space: nowrap">
				<tr><th>Дата</th><th>Комментарий</th><th>IP / Порт</th><th>Авторизация</th><th>Имя устройства</th><th>BSSID</th><th>ESSID</th><th>Тип защиты</th><th>Ключ сети</th><th>WPS PIN</th><th>Ссылки</th></tr>
				</thead>
				<tbody id=uploaded style="font-size: 12px">
				</tbody>
				</table>
			</div>
		</div>
		<div id=tab3 class=userCode dir=ltr style="display: none;">
			<table>
			<tr><td style="padding: 4 8 4 8" colspan=2>Избранные точки доступа.</td></tr>
			<tr><td style="vertical-align: top">
				<table class=st1>
				<thead style="white-space: nowrap">
				<tr><th><input type=checkbox /></th><th>Дата</th><th>Комментарий</th><th>Диапазон IP</th><th>BSSID</th><th>ESSID</th><th>Тип защиты</th><th>Ключ сети</th><th>WPS PIN</th><th>Ссылки</th></tr>
				</thead>
				<tbody id=favorited_aps style="font-size: 12px">
				</tbody>
				</table>
			</td><td style="vertical-align: top">
				<table class=graphbkg style="width: 200px; margin-left: 16px; padding: 8">
				<tr><td colspan=2>Всего точек: <span id=favap_cnt>0</span></td></tr>
				<tr><td align=left><button onclick="deleteFavorite()">Удалить</button></td><td></td></tr>
				</table>
			</td></tr>
			<tr><td style="padding: 4 8 4 8" colspan=2>Избранные локации.</td></tr>
			<tr><td style="vertical-align: top">
				<table class=st1>
				<thead style="white-space: nowrap">
				<tr><th><input type=checkbox /></th><th>Широта</th><th>Долгота</th><th>Комментарий</th><th>Ссылки</th></tr>
				</thead>
				<tbody id=favorited_loc style="font-size: 12px">
				</tbody>
				</table>
			</td><td style="vertical-align: top">
				<table class=graphbkg style="margin-left: 16px; padding: 8">
				<tr><td colspan=2>Всего локаций: <span id=favloc_cnt>0</span></td></tr>
				<tr><td align=right>Широта:</td><td><input type=text /></td></tr>
				<tr><td align=right>Долгота:</td><td><input type=text /></td></tr>
				<tr><td align=right>Комментарий:</td><td><input type=text /></td></tr>
				<tr><td align=right></td><td><button onclick="createLocation()">Добавить</button> <button onclick="updateLocation()">Сохранить</button></td></tr>
				<tr><td align=right></td><td><button onclick="deleteLocation()">Удалить</button></td></tr>
				</table>
			</td></tr>
			</table>
		</div>
		<div id=tab4 class=userCode dir=ltr style="display: none;">
			<div style="display: flex">
				<div style="max-height: 100%; overflow: auto">
					<table class=st1>
					<thead>
					<tr><th><input type=checkbox id=invchkall onclick="$('.invchk').prop('checked', this.checked)"></th><th>Дата приглашения</th><th>Дата регистрации</th><th>Код приглашения</th><th>Уровень доступа</th><th>Никнейм</th></tr>
					</thead>
					<tbody id=invtable>
					</tbody>
					</table>
				</div>
				<div class=graphbkg style="margin-left: 16px; padding: 8">
					<table>
					<tr><td colspan=2>Осталось приглашений: <span id=invcount></span></td></tr>
					<tr><td align=right><select id=invlevel></select></td><td><button onclick="createInvite()">Добавить</button></td></tr>
					<tr><td align=right><button onclick="updateInvite()">Сохранить</button></td><td><button onclick="deleteInvite()">Удалить</button></td></tr>
					</table>
				</div>
			</div>
		</div>
		<div id=tab5 class=userCode dir=ltr style="display: none; padding: 0">
			<table class=st2 cellspacing=0>
			<tr><td id=stat_em onclick="loadstat(this,'stat')" style="border-top: none">Сводная</td>
				<td rowspan=11 style="width: 100%; vertical-align: top; padding: 0">
				<div style="max-height: 396px; overflow-y: auto">
					<table class=st1 style="display: none;">
					<tbody>
					<tr><th>Кол-во <span id=sttot></span></th><th><span id=stval>Значение</span> <span id=stcnt></span></th></tr>
					</tbody>
					<tbody id=stat></tbody>
					</table>
				</div>
				</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stcmt')">Комментарии</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stdev')">Устройства</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stport')">Порты</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stauth')">Авторизация</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stbss')">BSSID</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stess')">ESSID</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stsec')">Защита</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stkey')">Ключи</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stwps')">WPS</td></tr>
			<tr><td id=stat_em onclick="loadstat(this,'stdns')">DNS</td></tr>
			</table>
		</div>
	</div>
</div>
</body>